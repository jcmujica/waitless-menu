---
import { fetchMenuById } from "@/services/menus/fetch-menu-by-id";
import { fetchRestaurantSettings } from "@/services/menus/fetch-restaurant-settings";
import type { IMenu, MenuPage } from "@/types/menu";
import Menu from "@/components/Menu.astro";
import MenuLayout from "@/layouts/MenuLayout.astro";
import { MenuCache } from "@/components/MenuCache";

const { menuId, page: pageId } = Astro.params;

// Fetch menu by ID (for preview - allows inactive menus)
const response = await fetchMenuById(menuId as string);
const menu = response.data as IMenu;
const error = response.error;
const accountId = response.accountId;

// Fetch account settings using the account_id from the menu
let accountSettings = null;
if (accountId) {
  const settingsResponse = await fetchRestaurantSettings(accountId);
  accountSettings = settingsResponse.data;
}

// Find the current page
const currentPage = menu?.pages?.find((page: MenuPage) => page.id === pageId);

// IMPORTANT: Do NOT cache preview pages
// Admins need to see real-time changes when editing menus
Astro.response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');

// IMPORTANT: Do NOT track analytics for preview views
// This is a preview mode for the admin panel
// Analytics tracking is intentionally omitted here
---

<MenuLayout menu={menu} accountSettings={accountSettings}>
  {/* Client-side cache for instant navigation between preview pages */}
  {menu && (
    <MenuCache 
      client:load
      type="preview"
      identifier={menuId as string}
      menu={menu}
      accountSettings={accountSettings ?? undefined}
    />
  )}
  <Menu
    menu={menu}
    currentPage={currentPage}
    accountSettings={accountSettings}
    error={error}
    menuId={menuId as string}
  />
</MenuLayout>
