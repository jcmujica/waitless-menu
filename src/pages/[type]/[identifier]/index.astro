---
import { fetchMenu } from "@/services/menus/fetch-menu";
import { fetchMenuByPath } from "@/services/menus/fetch-menu-by-path";
import { fetchRestaurantSettings } from "@/services/menus/fetch-restaurant-settings";
import type { IMenu } from "@/types/menu";
import Menu from "@/components/Menu.astro";
import MenuLayout from "@/layouts/MenuLayout.astro";

const { type, identifier } = Astro.params;

const PATH_TYPES = {
  ACCOUNT_ID: "qr",
  ACCOUNT_PATH: "v",
}

// Determine which fetch method to use based on the route type
let data, error, accountSettings;
if (type === PATH_TYPES.ACCOUNT_ID) {
  // For QR routes, fetch by account ID
  const response = await fetchMenu(identifier as string);
  data = response.data;
  error = response.error;
  
  // Fetch account settings
  const settingsResponse = await fetchRestaurantSettings(identifier as string);
  accountSettings = settingsResponse.data;
} else if (type === PATH_TYPES.ACCOUNT_PATH) {
  // For vanity URL routes, fetch by path
  const response = await fetchMenuByPath(identifier as string);
  data = response.data;
  accountSettings = response.accountSettings;
  error = response.error;
} else {
  // Handle unknown route types
  error = new Error(`Unknown route type: ${type}`);
}

const menu = data as IMenu;

// Cache the response at Vercel's edge for better performance
// - s-maxage=60: Cache at CDN edge for 60 seconds
// - stale-while-revalidate=300: Serve stale content for up to 5 min while revalidating in background
// This means: instant loads for 60s, then fast loads with background refresh for 5min
if (!error && menu) {
  Astro.response.headers.set(
    'Cache-Control',
    'public, s-maxage=60, stale-while-revalidate=300'
  );
} else {
  // Don't cache error responses
  Astro.response.headers.set('Cache-Control', 'no-store');
}
---

<MenuLayout menu={menu} accountSettings={accountSettings}>
  <Menu
    menu={menu}
    account={type === PATH_TYPES.ACCOUNT_ID ? identifier : undefined}
    accountPath={type === PATH_TYPES.ACCOUNT_PATH ? identifier : undefined}
    accountSettings={accountSettings}
    error={error}
  />
</MenuLayout>
