---
import { fetchMenu } from "@/services/menus/fetch-menu";
import { fetchRestaurantSettings, fetchRestaurantSettingsByPath } from "@/services/menus/fetch-restaurant-settings";
import { checkAccountAccess } from "@/services/account/check-account-access";
import type { IMenu, MenuPage, AccountAccess } from "@/types/menu";
import Menu from "@/components/Menu.astro";
import MenuLayout from "@/layouts/MenuLayout.astro";
import AccountUnavailable from "@/components/AccountUnavailable.astro";
import { MenuCache } from "@/components/MenuCache";
import { getServerLocale } from "@/utils/server-locale";
import { applyMenuTranslations } from "@/utils/apply-menu-translations";
import { getPageTranslation } from "@/utils/get-page-translations";

const { type, identifier, page: pageId } = Astro.params;

// Detect user's language preference
const userLanguage = getServerLocale(Astro.cookies, Astro.request.headers);

// Translation helper
const t = (key: string) => getPageTranslation(key, userLanguage);

// Initialize variables
let accountId: string | undefined;
let accountSettings;
let accountAccess: AccountAccess = { hasAccess: true, level: 'active' };
let menu: IMenu | undefined;

// Step 1: Validate route type
const isValidRouteType = type === "qr" || type === "v";

if (!isValidRouteType) {
  // Invalid route type - show not found
  accountAccess = { 
    hasAccess: false, 
    level: 'not_found', 
    message: t("This page doesn't exist. Please check the URL and try again.")
  };
} else if (type === "qr") {
  // QR route - use identifier as account ID directly
  accountId = identifier as string;
  
  // First verify account exists by fetching settings
  const settingsResponse = await fetchRestaurantSettings(accountId);
  
  if (settingsResponse.error || !settingsResponse.data) {
    // Account doesn't exist
    accountAccess = { 
      hasAccess: false, 
      level: 'not_found', 
      message: t("This page doesn't exist. Please check the URL and try again.")
    };
  } else {
    // Account exists (we have settings) - now check access status
    accountSettings = settingsResponse.data;
    accountAccess = await checkAccountAccess(accountId);
    
    // If checkAccountAccess says "not found" but we have settings, it's likely an RLS/query issue
    // In that case, assume account is active and proceed
    if (!accountAccess.hasAccess && accountAccess.message === 'Account not found') {
      // Account exists (we have settings), so allow access
      accountAccess = {
        hasAccess: true,
        level: 'active'
      };
    }
  }
} else if (type === "v") {
  // Vanity URL - resolve path to account ID first
  const settingsResponse = await fetchRestaurantSettingsByPath(identifier as string);
  
  if (settingsResponse.error || !settingsResponse.data) {
    // Path doesn't exist
    accountAccess = { 
      hasAccess: false, 
      level: 'not_found', 
      message: t("This page doesn't exist. Please check the URL and try again.")
    };
  } else {
    accountSettings = settingsResponse.data;
    accountId = accountSettings?.account_id;
    
    if (!accountId) {
      // Path exists but no account_id (shouldn't happen, but handle gracefully)
      accountAccess = { 
        hasAccess: false, 
        level: 'not_found', 
        message: t("This page doesn't exist. Please check the URL and try again.")
      };
    } else {
      // If we have account_settings, the account exists - just check status
      // Only check access status, not existence (we already know it exists)
      accountAccess = await checkAccountAccess(accountId);
      
      // If checkAccountAccess says "not found" but we have settings, it's likely an RLS/query issue
      // In that case, assume account is active and proceed
      if (!accountAccess.hasAccess && accountAccess.message === 'Account not found') {
        // Account exists (we have settings), so allow access
        accountAccess = {
          hasAccess: true,
          level: 'active'
        };
      }
    }
  }
}

// Step 2: Only fetch full menu data if account has access
if (accountAccess.hasAccess && accountId) {
  if (type === "qr") {
    // We already have settings from above, just fetch menu
    const menuResponse = await fetchMenu(accountId, userLanguage);
    
    if (menuResponse.error) {
      // Error fetching menu - show unavailable
      accountAccess = { 
        hasAccess: false, 
        level: 'inactive', 
        message: t('This menu is currently not available.')
      };
    } else {
      menu = menuResponse.data;
      
      // Apply translations if menu exists and account settings are available
      if (menu && accountSettings) {
        menu = applyMenuTranslations(menu, userLanguage, accountSettings);
      }
      
      // If menu doesn't exist for valid account
      if (!menu) {
        accountAccess = { 
          hasAccess: false, 
          level: 'not_found', 
          message: t('This menu is currently not available.')
        };
      }
    }
  } else if (type === "v") {
    // We already have settings, just fetch menu
    const menuResponse = await fetchMenu(accountId, userLanguage);
    
    if (menuResponse.error) {
      // Error fetching menu - show unavailable
      accountAccess = { 
        hasAccess: false, 
        level: 'inactive', 
        message: t('This menu is currently not available.')
      };
    } else {
      menu = menuResponse.data;
      
      // Apply translations if menu exists and account settings are available
      if (menu && accountSettings) {
        menu = applyMenuTranslations(menu, userLanguage, accountSettings);
      }
      
      // If menu doesn't exist for valid account
      if (!menu) {
        accountAccess = { 
          hasAccess: false, 
          level: 'not_found', 
          message: t('This menu is currently not available.')
        };
      }
    }
  }
}

// Find the current page
const currentPage = menu?.pages?.find((page: MenuPage) => page.id === pageId);

// Get theme for page (default to light if no menu)
const theme = (menu?.appearance?.theme || "light") as "light" | "dark";

// Cache the response at Vercel's edge for better performance
if (menu && accountAccess.hasAccess) {
  Astro.response.headers.set(
    'Cache-Control',
    'public, s-maxage=60, stale-while-revalidate=300'
  );
} else {
  Astro.response.headers.set('Cache-Control', 'no-store');
}
---

{/* Show unavailable page if account doesn't have access or menu is missing */}
{!accountAccess.hasAccess || !menu ? (
  <MenuLayout 
    menu={menu} 
    accountSettings={accountSettings}
    currentLanguage={userLanguage}
  >
    <AccountUnavailable 
      accountSettings={accountSettings}
      theme={theme}
      level={accountAccess.level}
      message={accountAccess.message}
    />
  </MenuLayout>
) : (
  <MenuLayout 
    menu={menu} 
    accountSettings={accountSettings}
    currentLanguage={userLanguage}
  >
    {/* Client-side cache for instant navigation between menu pages */}
    <MenuCache 
      client:load
      type={type as 'qr' | 'v'}
      identifier={identifier as string}
      menu={menu}
      accountSettings={accountSettings}
    />
    <Menu
      menu={menu}
      account={type === "qr" ? identifier : undefined}
      accountPath={type === "v" ? identifier : undefined}
      currentPage={currentPage}
      accountSettings={accountSettings}
    />
  </MenuLayout>
)}
