---
import { fetchMenu } from "@/services/menus/fetch-menu";
import { fetchMenuByPath } from "@/services/menus/fetch-menu-by-path";
import { fetchRestaurantSettings } from "@/services/menus/fetch-restaurant-settings";
import type { IMenu, MenuPage } from "@/types/menu";
import Menu from "@/components/Menu.astro";
import MenuLayout from "@/layouts/MenuLayout.astro";

const { type, identifier, page: pageId } = Astro.params;

// Determine which fetch method to use based on the route type
let data, error, accountSettings;
if (type === "qr") {
  // For QR routes, fetch by account ID
  const response = await fetchMenu(identifier as string);
  data = response.data;
  error = response.error;
  
  // Fetch account settings
  const settingsResponse = await fetchRestaurantSettings(identifier as string);
  accountSettings = settingsResponse.data;
} else if (type === "v") {
  // For vanity URL routes, fetch by path
  const response = await fetchMenuByPath(identifier as string);
  data = response.data;
  accountSettings = response.accountSettings;
  error = response.error;
} else {
  // Handle unknown route types
  error = new Error(`Unknown route type: ${type}`);
}

const menu = data as IMenu;

// Find the current page
const currentPage = menu?.pages?.find((page: MenuPage) => page.id === pageId);

// Cache the response at Vercel's edge for better performance
// - s-maxage=60: Cache at CDN edge for 60 seconds
// - stale-while-revalidate=300: Serve stale content for up to 5 min while revalidating in background
if (!error && menu) {
  Astro.response.headers.set(
    'Cache-Control',
    'public, s-maxage=60, stale-while-revalidate=300'
  );
} else {
  Astro.response.headers.set('Cache-Control', 'no-store');
}
---

<MenuLayout menu={menu} accountSettings={accountSettings}>
  <Menu
    menu={menu}
    account={type === "qr" ? identifier : undefined}
    accountPath={type === "v" ? identifier : undefined}
    currentPage={currentPage}
    accountSettings={accountSettings}
    error={error}
  />
</MenuLayout>
