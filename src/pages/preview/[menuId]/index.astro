---
import { fetchMenuById } from "@/services/menus/fetch-menu-by-id";
import { fetchRestaurantSettings } from "@/services/menus/fetch-restaurant-settings";
import type { IMenu, AccountAccess } from "@/types/menu";
import Menu from "@/components/Menu.astro";
import MenuLayout from "@/layouts/MenuLayout.astro";
import AccountUnavailable from "@/components/AccountUnavailable.astro";
import { MenuCache } from "@/components/MenuCache";
import { getServerLocale } from "@/utils/server-locale";
import { applyMenuTranslations } from "@/utils/apply-menu-translations";

const { menuId } = Astro.params;

// Detect user's language preference
const userLanguage = getServerLocale(Astro.cookies, Astro.request.headers);

// Initialize variables
let menu: IMenu | undefined;
let accountSettings = null;
let accountAccess: AccountAccess = { hasAccess: true, level: 'active' };

// Fetch menu by ID (for preview - allows inactive menus)
const response = await fetchMenuById(menuId as string, userLanguage);
menu = response.data;
const accountId = response.accountId;

// Check if menu exists
if (!menu) {
  accountAccess = { 
    hasAccess: false, 
    level: 'not_found', 
    message: 'This menu doesn\'t exist or may have been deleted.' 
  };
} else if (accountId) {
  // Fetch account settings using the account_id from the menu
  const settingsResponse = await fetchRestaurantSettings(accountId);
  accountSettings = settingsResponse.data;
  
  // Apply translations if menu exists and account settings are available
  if (menu && accountSettings) {
    menu = applyMenuTranslations(menu, userLanguage, accountSettings);
  }
}

// Get theme for page (default to light if no menu)
const theme = (menu?.appearance?.theme || "light") as "light" | "dark";

// IMPORTANT: Do NOT cache preview pages
// Admins need to see real-time changes when editing menus
Astro.response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');

// IMPORTANT: Do NOT track analytics for preview views
// This is a preview mode for the admin panel
// Analytics tracking is intentionally omitted here
---

{!accountAccess.hasAccess ? (
  <MenuLayout 
    menu={menu} 
    accountSettings={accountSettings}
    currentLanguage={userLanguage}
  >
    <AccountUnavailable 
      accountSettings={accountSettings ?? undefined}
      theme={theme}
      level={accountAccess.level}
      message={accountAccess.message}
    />
  </MenuLayout>
) : (
  <MenuLayout 
    menu={menu} 
    accountSettings={accountSettings}
    currentLanguage={userLanguage}
  >
    {/* Client-side cache for instant navigation between preview pages */}
    {menu && (
      <MenuCache 
        client:load
        type="preview"
        identifier={menuId as string}
        menu={menu}
        accountSettings={accountSettings ?? undefined}
      />
    )}
    <Menu
      menu={menu}
      accountSettings={accountSettings}
      menuId={menuId as string}
    />
  </MenuLayout>
)}
