---
import "../styles/global.css";
import "../styles/theme.css";
import { generateThemeVariables } from "@/utils/themeUtils";
import { ClientRouter } from "astro:transitions";
import type { IMenu } from "@/types/menu";

interface Props {
  menu?: IMenu;
}

const parseJSON = (obj: any) => {
  try {
    return typeof obj === 'string' ? JSON.parse(obj) : obj;
  } catch {
    return {};
  }
};

const { menu } = Astro.props;

const theme = (menu?.appearance?.theme || "light") as "light" | "dark";
const styleData = parseJSON(menu?.appearance?.style);
const primaryColor = styleData?.colors?.primary?.id?.split("-")[0] || "slate";
const themeVariables = generateThemeVariables(primaryColor);

// Custom background handling
const customBgImg = menu?.appearance?.custom_bg_img;
const customBgProps = parseJSON(menu?.appearance?.custom_bg_props);
const hasCustomBg = customBgImg && customBgProps?.mode !== "none";

// Pattern implementation
const implementation = styleData?.background?.implementation;
const containerClass = implementation?.container?.className || "";
const containerStyle = parseJSON(implementation?.container?.style) || {};
const bgClass = implementation?.background?.className || "";
const bgStyle = parseJSON(implementation?.background?.style) || {};
const animation = implementation?.animation;

const primaryColorStyles = Object.entries(themeVariables)
  .map(([key, value]) => `${key}: ${value};`)
  .join("\n        ");
---

<html lang="es" class={theme === "dark" ? "dark-mode" : "light-mode"}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content={theme} />
    <ClientRouter />
    <title>{menu?.name || "Menu"}</title>

    <!-- Inject primary color variables -->
    <style
      set:html={`
      :root {
        ${primaryColorStyles}
      }
      ${animation?.keyframes ? animation.keyframes : ''}
    `}
    ></style>

    <slot name="head" />
  </head>
  <body class="min-h-screen w-full relative" id="root">
    <main
      class={`${theme} ${hasCustomBg ? 'min-h-screen w-full relative' : (containerClass || 'min-h-screen w-full relative')}`}
      style={{
        ...(hasCustomBg ? {
          backgroundImage: `url(${customBgImg})`,
          backgroundSize: customBgProps.mode === 'pattern' ? '50px' : customBgProps.mode === 'centered' ? 'auto 80%' : 'cover',
          backgroundPosition: 'center',
          backgroundRepeat: customBgProps.mode === 'pattern' ? 'repeat' : 'no-repeat',
        } : containerStyle),
      }}
    >
      {!hasCustomBg && (bgStyle && Object.keys(bgStyle).length > 0) && (
        <div
          class={bgClass || "absolute inset-0 z-0"}
          style={{
            ...bgStyle,
            ...(animation?.name ? { animation: animation.name } : {}),
          }}
        />
      )}
      
      <div class="relative z-10">
        <slot />
      </div>
    </main>
  </body>
</html>

<style>
  html {
    --radius: 0.625rem;
  }
  .dark-mode {
    --background: oklch(14.5% 0 0);
    --foreground: oklch(98.5% 0 0);
    --card: oklch(20.5% 0 0);
    --card-foreground: oklch(98.5% 0 0);
    --popover: oklch(26.9% 0 0);
    --popover-foreground: oklch(98.5% 0 0);
    --muted: oklch(26.9% 0 0);
    --muted-foreground: oklch(70.8% 0 0);
    --accent: oklch(37.1% 0 0);
    --accent-foreground: oklch(98.5% 0 0);
    --destructive: oklch(70.4% 0.191 22.216);
    --border: oklch(100% 0 0 / 0.1);
    --input: oklch(100% 0 0 / 0.15);
    --ring: oklch(55.6% 0 0);
    --surface: oklch(20% 0 0);
    --surface-foreground: oklch(70.8% 0 0);
    --code: var(--surface);
    --code-foreground: var(--surface-foreground);
    --code-highlight: oklch(27% 0 0);
    --code-number: oklch(72% 0 0);
    --selection: oklch(92.2% 0 0);
    --selection-foreground: oklch(20.5% 0 0);
    --glass-bg: rgba(0, 0, 0, 0.35); /* darker glass */
    --glass-border: rgba(0, 0, 0, 0.35);
    background-color: var(--black);
  }
  .light-mode {
    /* Default light theme */
    --background: oklch(100% 0 0);
    --foreground: oklch(14.5% 0 0);
    --card: oklch(100% 0 0);
    --card-foreground: oklch(14.5% 0 0);
    --popover: oklch(100% 0 0);
    --popover-foreground: oklch(14.5% 0 0);
    --muted: oklch(97% 0 0);
    --muted-foreground: oklch(55.6% 0 0);
    --accent: oklch(97% 0 0);
    --accent-foreground: oklch(20.5% 0 0);
    --destructive: oklch(57.7% 0.245 27.325);
    --border: oklch(92.2% 0 0);
    --input: oklch(92.2% 0 0);
    --ring: oklch(70.8% 0 0);
    --surface: oklch(98% 0 0);
    --surface-foreground: var(--foreground);
    --code: var(--surface);
    --code-foreground: var(--surface-foreground);
    --code-highlight: oklch(96% 0 0);
    --code-number: oklch(56% 0 0);
    --selection: oklch(14.5% 0 0);
    --selection-foreground: oklch(100% 0 0);
    --glass-bg: rgba(255, 255, 255, 0.35);
    --glass-border: rgba(255, 255, 255, 0.35);
    background-color: var(--white);
  }
</style>
