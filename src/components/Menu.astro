---
import type { AccountSettings, IMenu, MenuPage } from "@/types/menu";
import Page from "./Page.astro";
import Footer from "./Footer.astro";
import Home from "./Home.astro";
import { getSecret } from "astro:env/server";

interface Props {
  menu: IMenu;
  currentPage?: MenuPage;
  account?: string;
  accountPath?: string;
  accountSettings?: AccountSettings;
  error?: Error | unknown;
  menuId?: string; // For preview routes
}

const {
  menu,
  currentPage: currentPageProp,
  account,
  accountPath,
  accountSettings,
  error,
  menuId,
} = Astro.props;
const isSinglePage = menu?.type === "single-page";
const isMultiPage = menu?.type === "multi-page";
let currentPage =
  currentPageProp ||
  (isSinglePage &&
    menu?.pages?.find((page: MenuPage) => page.id === menu?.mainPageId));
// Determine the route type based on available params
const isQrRoute = !!account;
const isPreviewRoute = !!menuId;
const isPageView = !!currentPage || (isSinglePage && !menu?.mainPageId);

// Determine the route type for the dynamic routing
const routeType = isPreviewRoute ? "preview" : (isQrRoute ? "qr" : "v");
const identifier = isPreviewRoute 
  ? menuId 
  : (isQrRoute ? (account as string) : (accountPath as string));

// Generate the base URL for navigation
const baseUrl = identifier && routeType ? `/${routeType}/${identifier}` : "";

const isPageNotFound = isPageView && !currentPage && menu;
const shouldRedirect = isPageNotFound || error;
const shouldShowHome = isMultiPage && !isPageView;
const shouldShowPage = isPageView && currentPage;

// Get Supabase credentials for client-side tracking
const supabaseUrl = (() => {
  try {
    return getSecret('SUPABASE_URL') || '';
  } catch (error) {
    console.warn('SUPABASE_URL not configured for analytics tracking');
    return '';
  }
})();

const supabaseAnonKey = (() => {
  try {
    return getSecret('SUPABASE_ANON_KEY') || '';
  } catch (error) {
    console.warn('SUPABASE_ANON_KEY not configured for analytics tracking');
    return '';
  }
})();
---

<Fragment>
  <title slot="head">{menu?.name || "Menu"}</title>
  <script slot="head" define:vars={{ baseUrl, shouldRedirect }} is:inline>
    if (shouldRedirect) {
      window.location.href = baseUrl;
    }
  </script>
  {menu?.id && accountSettings?.account_id && supabaseUrl && supabaseAnonKey && !isPreviewRoute && (
    <script define:vars={{ menuId: menu.id, accountId: accountSettings.account_id, supabaseUrl, supabaseAnonKey }} is:inline>
      (function() {
        // Only track once per page load
        if (document.documentElement.hasAttribute('data-menu-view-tracked')) {
          return;
        }
        
        // Mark as tracked
        document.documentElement.setAttribute('data-menu-view-tracked', 'true');
        
        // Track the view (fire and forget)
        if (menuId && accountId && supabaseUrl && supabaseAnonKey) {
          fetch(`${supabaseUrl}/functions/v1/trackMenuView`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${supabaseAnonKey}`,
            },
            body: JSON.stringify({
              menu_id: menuId,
              account_id: accountId,
            }),
          }).catch((err) => {
            console.debug('Menu view tracking error:', err);
          });
        }
      })();
    </script>
  )}

  <div class="w-full">
    <div class="max-w-2xl mx-auto">
      {
        menu && (
          <>
            {/* Navigation for multi-page menus when not in page view */}
            {shouldShowHome && <Home menu={menu} baseUrl={baseUrl} accountSettings={accountSettings} />}

            {/* Main content area */}
            {/* Specific page view */}
            {shouldShowPage && (
              <Page
                baseUrl={baseUrl}
                id={currentPage.id}
                items={currentPage.items}
                menu={menu}
                accountSettings={accountSettings}
              />
            )}
            <Footer />
          </>
        )
      }
    </div>
  </div>
</Fragment>
