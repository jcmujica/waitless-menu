---
import { Image } from "astro:assets";
import type { MenuItem } from "@/types/menu";
import ItemModal from "./ItemModal.astro";
import { formatPrice } from "@/utils/formatPrice";
import Section from "./Section.astro";
import { ITEM_CLASSES } from "@/constants/items";
import SpicySvg from "@/assets/icons/spicy.svg";
import VeganSvg from "@/assets/icons/vegan.svg";
import GlutenFreeSvg from "@/assets/icons/gluten-free.svg";

// Define the props for the Item component
interface Props {
  item?: MenuItem;
  settings: {
    showPrices: boolean;
    showImages: boolean;
    showDescriptions: boolean;
  };
  hasItemsWithClasses?: boolean;
}

// Destructure the props
const { item, settings, hasItemsWithClasses = false } = Astro.props;

const { name, price, image_url, description, classes } = item || {};
const { showPrices, showImages, showDescriptions } = settings;
const extraSpace = hasItemsWithClasses && (!classes || classes.length === 0);

// Create a JSON string with the item data for the modal
const itemData = item
  ? JSON.stringify({
      name,
      price,
      image_url,
      description,
      showPrices,
      showImages,
      showDescriptions,
    })
  : null;
---

<script>
  // Add click event listeners to all menu items
  document.addEventListener("DOMContentLoaded", () => {
    const menuItems = document.querySelectorAll(".menu-item");

    menuItems.forEach((item) => {
      item.addEventListener("click", () => {
        const itemId = item.getAttribute("data-item-id");
        const modal = document.getElementById(`item-modal-${itemId}`);

        if (modal && modal instanceof HTMLDialogElement) {
          // First set initial state (if not already set by CSS)
          modal.style.opacity = "0";
          modal.style.transform = "scale(0.95) translateY(10px)";

          // Show the modal
          modal.showModal();

          // Force a reflow to ensure the initial state is applied
          void modal.offsetWidth;

          // Then remove the inline styles to let CSS transitions take over
          setTimeout(() => {
            modal.style.opacity = "";
            modal.style.transform = "";
          }, 10);
        }
      });
    });
  });
</script>

{
  item?.type === "item" && (
    <>
      <li
        id={`item-${item.id}`}
        class="glassmorphism tint menu-item relative flex w-full justify-between items-center gap-4 rounded-lg border shadow-xs overflow-hidden cursor-pointer"
        data-item-id={item.id}
        data-item-data={itemData}
      >
        {showImages && image_url && (
          <div class="rounded-l-lg overflow-hidden shrink-0 self-stretch">
            <Image
              class="object-cover object-center h-full w-[80px]"
              src={image_url}
              alt={name || ""}
              width={80}
              height={80}
              inferSize
            />
          </div>
        )}
        <div class={`flex flex-col gap-1 grow py-3`}>
          {extraSpace && <div class="h-2.5 mt-1" />}
          <h3 class="font-bold text-md line-clamp-1">{name}</h3>
          {showDescriptions && description && (
            <p class="text-xs line-clamp-1 opacity-70">{description}</p>
          )}
          {classes && classes.length > 0 && (
            <div class="flex gap-2 mt-1">
              {classes.map((classId: string) => {
                const itemClass = ITEM_CLASSES[parseInt(classId)];

                switch (itemClass.id) {
                  case "spicy":
                    return (
                      <SpicySvg class="w-5 h-5 opacity-70 fill-amber-50" />
                    );
                  case "vegan":
                    return (
                      <VeganSvg class="w-5 h-5 opacity-70 fill-amber-50" />
                    );
                  case "gluten-free":
                    return (
                      <GlutenFreeSvg class="w-5 h-5 opacity-70 fill-amber-50" />
                    );
                  default:
                    return null;
                }
              })}
            </div>
          )}
          {extraSpace && <div class="h-2.5 mt-1" />}
        </div>
        {showPrices && price !== null && price !== undefined && (
          <div class="flex flex-col gap-2 items-center shrink-0 pr-4">
            <p class="price text-sm font-bold">{formatPrice(price)}</p>
          </div>
        )}
      </li>
      <ItemModal item={item} />
    </>
  )
}

{item?.type === "section" && <Section name={item.name} />}

<style>
  :global(.light-mode) {
    .menu-item {
      background-color: var(--primary-50);
      border: 1px solid var(--glass-border);
    }

    .price {
      color: var(--primary-800);
    }
  }

  :global(.dark-mode) {
    .menu-item {
      background-color: var(--neutral-900);
      border: 1px solid var(--glass-border);
    }

    .price {
      color: var(--primary-200);
    }
  }
</style>
