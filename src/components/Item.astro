---
import { Image } from "astro:assets";
import { getSecret } from "astro:env/server";
import type { MenuItem } from "@/types/menu";
import ItemModal from "./ItemModal.astro";
import { formatPrice } from "@/utils/formatPrice";
import Section from "./Section.astro";
import { ITEM_CLASSES } from "@/constants/items";
import SpicySvg from "@/assets/icons/spicy.svg";
import VeganSvg from "@/assets/icons/vegan.svg";
import GlutenFreeSvg from "@/assets/icons/gluten-free.svg";

// Define the props for the Item component
interface Props {
  item?: MenuItem;
  settings: {
    showPrices: boolean;
    showImages: boolean;
    showDescriptions: boolean;
  };
  hasItemsWithClasses?: boolean;
  menuId?: string;
  accountId?: string;
}

// Destructure the props
const { item, settings, hasItemsWithClasses = false, menuId, accountId } = Astro.props;

// Store both IDs:
// - item.id: menu_items table ID (for modal)
// - item.item_id: items table ID (for tracking/analytics)
const menuItemId = item?.id || ''; // For modal
const trackingItemId = item?.item_id || item?.id || ''; // For analytics

// Get Supabase credentials for client-side tracking
const supabaseUrl = (() => {
  try {
    return getSecret('SUPABASE_URL');
  } catch (error) {
    console.warn('SUPABASE_URL not configured for analytics tracking');
    return '';
  }
})();

const supabaseAnonKey = (() => {
  try {
    return getSecret('SUPABASE_ANON_KEY');
  } catch (error) {
    console.warn('SUPABASE_ANON_KEY not configured for analytics tracking');
    return '';
  }
})();

const { name, price, image_url, description, classes } = item || {};
const { showPrices, showImages, showDescriptions } = settings;
const extraSpace = hasItemsWithClasses && (!classes || classes.length === 0);

// Create a JSON string with the item data for the modal
const itemData = item
  ? JSON.stringify({
      name,
      price,
      image_url,
      description,
      showPrices,
      showImages,
      showDescriptions,
    })
  : null;
---

<script>
  import { initializeMenuItems } from '@/scripts/item-click-handler';
  initializeMenuItems();
</script>

{
  item?.type === "item" && (
    <>
      <li
        id={`item-${item.id}`}
        class="menu-item relative flex w-full justify-between items-center gap-4 rounded-lg border shadow-xs overflow-hidden cursor-pointer"
        data-menu-item-id={menuItemId}
        data-item-id={trackingItemId}
        data-item-data={itemData}
        data-menu-id={menuId}
        data-account-id={accountId}
        data-supabase-url={supabaseUrl}
        data-supabase-anon-key={supabaseAnonKey}
      >
        {showImages && image_url && (
          <div class="rounded-l-lg overflow-hidden shrink-0 self-stretch">
            <Image
              class="object-cover object-center h-full w-[80px]"
              src={image_url}
              alt={name || ""}
              width={80}
              height={80}
              loading="eager"
              inferSize
            />
          </div>
        )}
        <div class={`flex flex-col gap-1 grow py-3`}>
          {extraSpace && <div class="h-2.5 mt-1" />}
          <h3 class="font-bold text-md line-clamp-1 item-name">{name}</h3>
          {showDescriptions && description && (
            <p class="text-xs line-clamp-1 opacity-70">{description}</p>
          )}
          {classes && classes.length > 0 && (
            <div class="flex gap-2 mt-1">
              {classes.map((classId: string) => {
                const itemClass = ITEM_CLASSES[parseInt(classId)];

                switch (itemClass.id) {
                  case "spicy":
                    return (
                      <SpicySvg class="w-5 h-5 opacity-70 fill-amber-50" />
                    );
                  case "vegan":
                    return (
                      <VeganSvg class="w-5 h-5 opacity-70 fill-amber-50" />
                    );
                  case "gluten-free":
                    return (
                      <GlutenFreeSvg class="w-5 h-5 opacity-70 fill-amber-50" />
                    );
                  default:
                    return null;
                }
              })}
            </div>
          )}
          {extraSpace && <div class="h-2.5 mt-1" />}
        </div>
        {showPrices && price !== null && price !== undefined && (
          <div class="flex flex-col gap-2 items-center shrink-0 pr-4">
            <p class="price text-sm font-bold">{formatPrice(price)}</p>
          </div>
        )}
      </li>
      <ItemModal item={item} />
    </>
  )
}

{item?.type === "section" && <Section name={item.name} />}

<style>
  .menu-item {
    transition: transform 0.15s ease;
  }

  .menu-item:active {
    transform: scale(0.98);
  }

  :global(.light-mode) {
    .menu-item {
      background-color: var(--primary-50);
      border: 1px solid var(--glass-border);
    }

    .item-name {
      color: var(--primary-700);
    }

    .price {
      color: var(--primary-800);
    }
  }

  :global(.dark-mode) {
    .menu-item {
      background-color: var(--neutral-900);
      border: 1px solid var(--glass-border);
    }

    .item-name {
      color: var(--primary-300);
    }

    .price {
      color: var(--primary-200);
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .menu-item {
      transition: none;
    }
    
    .menu-item:active {
      transform: none;
    }
  }
</style>
