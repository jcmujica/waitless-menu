---
import Item from "./Item.astro";
import type { AccountSettings, MenuItem, MenuPage } from "@/types/menu";
import FloatingButton from "./Buttons/FloatingButton.astro";
import Navigation from "./Navigation.astro";
import type { IMenu } from "@/types/menu";
interface Props {
  id: string;
  menu: IMenu;
  items: MenuItem[];
  baseUrl: string;
  showNavigation?: boolean;
  accountSettings?: AccountSettings;
}

const {
  id,
  items = [],
  menu,
  baseUrl,
  showNavigation = true,
  accountSettings,
} = Astro.props;
const settings = {
  showPrices: menu?.settings?.showPrices ?? true,
  showImages: menu?.settings?.showImages ?? true,
  showDescriptions: menu?.settings?.showDescriptions ?? true,
};
const isSinglePage = menu?.type === "single-page";

const allSections =
  menu?.pages?.flatMap((page: MenuPage) => {
    return page.items
      .filter((item: MenuItem) => item.type === "section")
      .map((section: MenuItem) => ({
        id: `section-${section.id}`,
        name: section.name,
        pageId: page.id,
      }));
  }) || [];

const pageSections = items.filter((item) => item.type === "section");

// Generate unique IDs for sections based on their names
const pageSectionIds = pageSections.map((section) => ({
  id: `section-${section.id}`,
  name: section.name,
  pageId: id,
}));

// Determine which sections to display in the navigation
// For single-page menu, use allSections (passed from Menu component)
// For multi-page menu, use only the sections from the current page
const navigationSections = isSinglePage ? allSections : pageSectionIds;

// Check if any items have classes to maintain consistent height
const hasItemsWithClasses = items.some(
  (item) => item.type === "item" && item.classes && item.classes.length > 0,
);
---

<main id={`page-${id}`} class="min-h-screen flex flex-col">
  {
    showNavigation && (
      <Navigation
        sections={navigationSections}
        accountSettings={accountSettings}
      />
    )
  }

  <ul class="menu-items-list flex flex-col gap-3 p-3">
    {
      items.map((item, index) => {
        // For section items, add an ID to use as scroll target
        const sectionId = item.type === "section" ? `section-${item.id}` : "";
        const isSection = item.type === "section";
        
        return (
          <div
            id={sectionId}
            class={`menu-item-wrapper ${isSection ? "scroll-mt-16 not-first:mt-4" : ""}`}
            style={`--item-index: ${index}`}
            transition:name={`item-${item.id}`}
            transition:animate="slide"
          >
            <Item
              item={item}
              settings={settings}
              hasItemsWithClasses={hasItemsWithClasses}
              menuId={menu.id}
              accountId={accountSettings?.account_id}
            />
          </div>
        );
      })
    }
  </ul>
  {!isSinglePage && <FloatingButton href={baseUrl} />}
</main>

<style>
  /* Staggered entrance animation for menu items */
  .menu-item-wrapper {
    animation: itemSlideIn 0.4s ease-out backwards;
    animation-delay: calc(var(--item-index) * 40ms);
  }

  @keyframes itemSlideIn {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .menu-item-wrapper {
      animation: none;
    }
  }
</style>

<style is:global>
  /* View Transition: Subtle slide for menu items */
  @keyframes item-slide-in {
    from {
      opacity: 0;
      transform: translateY(8px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes item-slide-out {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(-8px) scale(0.98);
    }
  }

  /* Apply to items during view transitions */
  [transition\:name^="item-"]::view-transition-old(root) {
    animation: item-slide-out 200ms ease-in forwards;
  }

  [transition\:name^="item-"]::view-transition-new(root) {
    animation: item-slide-in 300ms ease-out forwards;
  }

  /* Stagger the view transitions for items */
  ::view-transition-group(item-*) {
    animation-delay: calc(var(--item-index, 0) * 30ms);
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    [transition\:name^="item-"]::view-transition-old(root),
    [transition\:name^="item-"]::view-transition-new(root) {
      animation: none;
    }
  }
</style>
